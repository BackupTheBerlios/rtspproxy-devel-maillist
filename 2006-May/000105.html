<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Rtspproxy-devel] r422 - trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/rtspproxy-devel/2006-May/index.html" >
   <LINK REL="made" HREF="mailto:rtspproxy-devel%40lists.berlios.de?Subject=Re%3A%20%5BRtspproxy-devel%5D%20r422%20-%20trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy&In-Reply-To=%3C200605021527.k42FRKix030312%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000104.html">
   <LINK REL="Next"  HREF="000106.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Rtspproxy-devel] r422 - trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy</H1>
    <B>merlimat at berlios.de</B> 
    <A HREF="mailto:rtspproxy-devel%40lists.berlios.de?Subject=Re%3A%20%5BRtspproxy-devel%5D%20r422%20-%20trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy&In-Reply-To=%3C200605021527.k42FRKix030312%40sheep.berlios.de%3E"
       TITLE="[Rtspproxy-devel] r422 - trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy">merlimat at berlios.de
       </A><BR>
    <I>Tue May  2 17:27:20 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000104.html">[Rtspproxy-devel] r421 - in trunk/RTSPProxy-Core/src/main/java: . rtspproxy/proxy/track rtspproxy/rdt
</A></li>
        <LI>Next message: <A HREF="000106.html">[Rtspproxy-devel] r423 - in trunk/RTSPProxy-Core/src/main/java/rtspproxy/filter: . ipaddress
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#105">[ date ]</a>
              <a href="thread.html#105">[ thread ]</a>
              <a href="subject.html#105">[ subject ]</a>
              <a href="author.html#105">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: merlimat
Date: 2006-05-02 17:27:15 +0200 (Tue, 02 May 2006)
New Revision: 422

Modified:
   trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy/ProxySession.java
Log:
Exposed methods for JMX management.

Modified: trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy/ProxySession.java
===================================================================
--- trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy/ProxySession.java	2006-05-02 15:26:24 UTC (rev 421)
+++ trunk/RTSPProxy-Core/src/main/java/rtspproxy/proxy/ProxySession.java	2006-05-02 15:27:15 UTC (rev 422)
@@ -18,16 +18,18 @@
 
 package rtspproxy.proxy;
 
+import java.util.Collection;
+import java.util.Collections;
+import java.util.Date;
+import java.util.HashSet;
 import java.util.Map;
 import java.util.Random;
+import java.util.Set;
 import java.util.concurrent.ConcurrentHashMap;
 
-import javax.management.ObjectName;
-
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
-import rtspproxy.jmx.JmxAgent;
 import rtspproxy.lib.number.UnsignedInt;
 import rtspproxy.lib.number.UnsignedLong;
 import rtspproxy.proxy.track.RdtTrack;
@@ -54,6 +56,8 @@
     /** Map IDs for RTSP session with clients to ProxySession objects. */
     private static Map&lt;String, ProxySession&gt; clientSessionIds = new ConcurrentHashMap&lt;String, ProxySession&gt;();
 
+    private static Set&lt;ProxySession&gt; sessions = Collections.synchronizedSet( new HashSet&lt;ProxySession&gt;() );
+
     /**
      * Retrieve the ProxySession associated with the given session ID used by
      * the client.
@@ -86,6 +90,13 @@
         return serverSessionIds.get( serverSessionId );
     }
 
+    public static Set&lt;ProxySession&gt; getActiveSessions()
+    {
+        return Collections.unmodifiableSet( sessions );
+    }
+
+    ///////////////////////////////////////
+
     /**
      * This is the session ID generated by the proxy and used for the
      * communication with the client.
@@ -98,49 +109,29 @@
      */
     private String serverSessionId = null;
 
-    /** Tells whether the proxySession has already been closed. */
-    private boolean closedFlag = false;
-
     /**
      * Collection of Track associated with this ProxySession.
      */
     private Map&lt;String, Track&gt; trackList = new ConcurrentHashMap&lt;String, Track&gt;();
 
     /**
-     * object name of proxy session
-     */
-    private ObjectName objectName;
-
-    /**
      * the special server-side session which handles RTP sessions with different
      * local source ports
      */
     private PortrangeRtpServerSession portrangeRtpServerSession;
 
-    /**
-     * @return Returns the objectName.
-     */
-    public ObjectName getObjectName()
-    {
-        return objectName;
-    }
+    private final Date startDate;
 
     /**
-     * @param objectName
-     *            The objectName to set.
-     */
-    public void setObjectName( ObjectName objectName )
-    {
-        this.objectName = objectName;
-    }
-
-    /**
      * Construct a new ProxySession. The session ID that will be used when
      * communicating with the client will be generated.
      */
     public ProxySession()
     {
+        startDate = new Date();
         setClientSessionId( newSessionID() );
+        sessions.add( this );
+        
         log.debug( &quot;\n----------\nCreated new proxy session: {} \n----------&quot;,
                 clientSessionId );
     }
@@ -212,7 +203,6 @@
     {
         this.clientSessionId = clientSessionId;
         clientSessionIds.put( clientSessionId, this );
-        makeManaged();
     }
 
     /**
@@ -226,27 +216,18 @@
         this.serverSessionId = serverSessionId;
         if ( serverSessionId != null )
             serverSessionIds.put( serverSessionId, this );
-        makeManaged();
     }
 
-    /**
-     * check if both client and server session id's are set and register proxy
-     * session facade MBean
-     */
-    private void makeManaged()
+    public Date getStartDate()
     {
-        if ( this.clientSessionId != null &amp;&amp; this.serverSessionId != null )
-            JmxAgent.getInstance().registerProxySession( this );
-    }
+        return startDate;
+    }    
 
     /**
      * Closes the entire proxy session and frees all associated resources.
      */
     public synchronized void close()
     {
-        if ( closedFlag )
-            return;
-
         log.debug( &quot;TrackList: {}&quot;, trackList );
 
         // close all associated tracks
@@ -254,7 +235,6 @@
             entry.getValue().close();
         }
 
-        closedFlag = true;
         log.debug( &quot;Closed proxySession: {}&quot;, clientSessionId );
 
         String s = &quot;&quot;;
@@ -273,12 +253,11 @@
         if ( serverSessionId != null )
             serverSessionIds.remove( serverSessionId );
 
+        sessions.remove( this );
+
         if ( this.portrangeRtpServerSession != null )
             PortrangeRtpServerSessionFactory.getInstance().releaseSession(
                     this.portrangeRtpServerSession );
-
-        // unregister session facade in MBean server
-        JmxAgent.getInstance().unregisterProxySession( this );
     }
 
     // ///////////////////
@@ -331,18 +310,15 @@
         }
     }
 
-    /**
-     * @return Returns the closedFlag.
-     */
-    public boolean isClosed()
-    {
-        return closedFlag;
-    }
-
     public void setPortrangeRtpServerSession(
             PortrangeRtpServerSession portrangeRtpSession )
     {
         this.portrangeRtpServerSession = portrangeRtpSession;
     }
 
+    public Collection&lt;Track&gt; getTrackList()
+    {
+        return trackList.values();
+    }
+
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000104.html">[Rtspproxy-devel] r421 - in trunk/RTSPProxy-Core/src/main/java: . rtspproxy/proxy/track rtspproxy/rdt
</A></li>
	<LI>Next message: <A HREF="000106.html">[Rtspproxy-devel] r423 - in trunk/RTSPProxy-Core/src/main/java/rtspproxy/filter: . ipaddress
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#105">[ date ]</a>
              <a href="thread.html#105">[ thread ]</a>
              <a href="subject.html#105">[ subject ]</a>
              <a href="author.html#105">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/rtspproxy-devel">More information about the Rtspproxy-devel
mailing list</a><br>
</body></html>
